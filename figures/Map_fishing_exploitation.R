
rm(list=ls())

### load libraries
library(sp)
library(maptools)
library(sf)
library(gridExtra)
library(viridis)
library(ggplot2)
library(latex2exp)

##################
load("processed data/surveyed_grid.RData") # get grid information
load("processed data/Biomass_grid.RData") # get biomass per grid cell and year

cpue_final <- subset(cpue_good,cpue_good$year >= 1990 & cpue_good$year <= 2015)
cpue_final <-  aggregate(list(cpue_final$biomass,cpue_final$tlw,
                              cpue_final$Catch_sqkm,cpue_final$Catch_pel_sqkm),
                         by=list(cpue_final$uni_cell),FUN = mean,na.rm=T)
colnames(cpue_final) <- c("uni_cell","biomass","tlw","Catch_sqkm","Catch_pel_sqkm")

grid_master <- cbind(grid_master,cpue_final[match(grid_master@data$uni_cell,cpue_final$uni_cell),c(2:5)])
ncoords <- subset(grid_master,!(is.na(grid_master@data$biomass)))
ncoords$ER <- ncoords$Catch_sqkm / ncoords$biomass

ctrys <- rnaturalearth::ne_countries(scale = 50, returnclass = "sf")
minlong <- -180 #round(min(filedata$long)-1)
maxlong <- 51
minlat  <- 23
maxlat  <- 83
coordslim <- c(minlong,maxlong,minlat,maxlat)
coordxmap <- round(seq(minlong,maxlong,length.out = 4))
coordymap <- round(seq(minlat,maxlat,length.out = 4))

ncoords$ER[ncoords$ER>0.20] <- 0.20
nco <- sf::st_as_sf(ncoords)

# plot map
figmap1 <- ggplot(nco) + 
  geom_sf( aes(fill=ER), colour = NA ) + 
  scale_fill_viridis(name="Exploitation rate \n \n", limits = c(0,0.2),
                     labels = c("0","0.1",TeX("$\\geq$0.2")),breaks=c(0,0.1,0.2))  + 
  geom_sf(data = ctrys, fill="grey",colour=NA) +
  coord_sf(crs = 5070,xlim = c(-4927853,3633046),ylim=c(307076,6029855))

figmap1 <- figmap1 +  theme(plot.background=element_blank(),
                            panel.grid.major = element_line(colour = "grey"),
                            panel.background=element_blank(),
                            axis.text.y   = element_text(size=10),
                            axis.text.x   = element_text(size=10),
                            axis.title.y  = element_blank(),
                            plot.title = element_text(size = 11),
                            axis.title.x  = element_blank(),
                            panel.border  = element_rect(colour = "grey", size=.5,fill=NA),
                            legend.text   = element_text(size=10),
                            legend.title  = element_text(size=10),
                            legend.key.size = unit(.4, 'cm'),
                            legend.position = "bottom")

figmap2 <- ggplot(nco) + 
  geom_sf( aes(fill=ER), colour = NA ) + 
  scale_fill_viridis(name="Exploitation rate \n \n", limits = c(0,0.2),
                     labels = c("0","0.1",TeX("$\\geq$0.2")),breaks=c(0,0.1,0.2))  + 
  geom_sf(data = ctrys, fill="grey",colour=NA) +
  coord_sf(crs =  "+proj=aea +lat_0=23 +lon_0=10 +lat_1=29.5 +lat_2=45.5 +x_0=0 
           +y_0=0 +datum=NAD83 +units=m +no_defs", 
           xlim = c(-2427853,2333046),ylim=c(807076,6029855))

figmap2 <-  figmap2 +  theme(plot.background=element_blank(),
                             panel.grid.major = element_line(colour = "grey"),
                             panel.background=element_blank(),
                             axis.text.y   = element_text(size=10),
                             axis.text.x   = element_text(size=10),
                             axis.title.y  = element_blank(),
                             plot.title = element_text(size = 11),
                             axis.title.x  = element_blank(),
                             panel.border  = element_rect(colour = "grey", size=.5,fill=NA),
                             legend.text   = element_text(size=10),
                             legend.title  = element_text(size=9),
                             legend.key.size = unit(.4, 'cm'),
                             legend.position = "bottom")


pdf("figures/Map_fishing_exploitation.pdf",width=10,height=5)
cowplot::plot_grid(figmap1,figmap2,nrow = 1, rel_widths=c(0.60,0.40))
dev.off()